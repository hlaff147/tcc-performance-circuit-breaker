server:
  port: 8080

spring:
  application:
    name: payment-service-v3

# Configuração do Retry com Backoff Exponencial
resilience4j:
  retry:
    configs:
      default:
        # Métricas para Prometheus
        registerHealthIndicator: true
    instances:
      adquirente-retry:
        # Número máximo de tentativas (incluindo a primeira)
        maxAttempts: 3
        
        # Tempo de espera entre tentativas
        waitDuration: 500ms
        
        # Backoff exponencial: multiplica o tempo de espera a cada retry
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        # waitDuration inicial: 500ms -> 1000ms -> 2000ms
        
        # Randômico: adiciona variação para evitar thundering herd
        enableRandomizedWait: true
        randomizedWaitFactor: 0.5
        
        # Exceções que disparam retry
        retryExceptions:
          - java.net.SocketTimeoutException
          - java.net.ConnectException
          - java.io.IOException
          - feign.FeignException$ServiceUnavailable
          - feign.FeignException$InternalServerError
          - org.springframework.web.client.HttpServerErrorException
        
        # Exceções que NÃO disparam retry
        ignoreExceptions:
          - java.lang.IllegalArgumentException
          - feign.FeignException$BadRequest

# Configuração do Feign Client com timeout
feign:
  client:
    config:
      default:
        connectTimeout: 2000
        readTimeout: 3000

management:
  endpoints:
    web:
      exposure:
        include: health,info,retries,retryevents,metrics,prometheus
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    prometheus:
      enabled: true
  health:
    retry:
      enabled: true
    livenessState:
      enabled: true
    readinessState:
      enabled: true
  metrics:
    tags:
      application: payment-service-v3
      version: v3
      experiment: retry-tcc
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
        resilience4j.retry.calls: true
        payment.processing.time: true
      percentiles:
        http.server.requests: 0.5, 0.9, 0.95, 0.99
        resilience4j.retry.calls: 0.5, 0.9, 0.95, 0.99
        payment.processing.time: 0.5, 0.9, 0.95, 0.99
      slo:
        http.server.requests: 100ms, 200ms, 500ms, 1s, 2s, 5s
